# TODO - UniSet2 Viewer

## В работе

### SSE улучшения
- [x] Индикатор состояния SSE соединения в UI (connected/reconnecting/polling)
- [x] Отображение времени последнего обновления в UI

### Тестирование
- [ ] Playwright e2e тесты на SSE функциональность
- [ ] Playwright тесты на fallback к polling при недоступности SSE

### Типы объектов
- [ ] Проработать отображение для других типов объектов
- [ ] Документировать API рендереров для расширения

### Архитектура
- [ ] Обсудить: сервер возвращает сырой JSON, парсинг на UI (сервер не знает формат полей)

---

## Выполнено

### UI улучшения

#### Графики и шкала времени
- [x] Шкала времени: начало с момента добавления первого графика, ширина = выбранный интервал
- [x] При добавлении последующих датчиков шкала не меняется
- [x] Когда графики доезжают до конца - смещение на 90% (настраиваемый параметр)
- [x] Дополнительные временные интервалы: 1m, 3m, 3h

#### Внешний вид
- [x] Техно-шрифт для заголовка "UniSet2 Viewer"
- [x] textname датчика в шапку графика
- [x] textname в таблицы входов/выходов
- [x] Подсветка состояния LogServer: RUNNING (зелёный), STOPPED (красный)

#### Новые разделы (collapsible)
- [x] Раздел "Информация об объекте" (object) - внизу
- [x] Раздел "Статистика" (Statistics) с таблицей сенсоров (ID, имя, срабатывания) и фильтром
- [x] Раздел "Таймеры" (Timers) - рядом с входами/выходами (динамическая информация)
- [x] Раздел "LogServer" (если есть в ответе)

#### Сохранение состояния
- [x] Сохранение состояния спойлеров в localStorage

#### Архитектура рендереров
- [x] Расширяемая система рендереров по objectType
- [x] BaseObjectRenderer — базовый класс
- [x] UniSetManagerRenderer — полный функционал (IO, Timers, Variables, Statistics, LogServer)
- [x] UniSetObjectRenderer — упрощённый вид (без IO/Timers)
- [x] Badge с типом объекта на вкладке

### Внешние датчики из SharedMemory (SM)

- [x] Кнопка "Добавить датчик" в `createChartsSection()` (в заголовке секции "Графики")
- [x] HTML/CSS модального окна
- [x] Загрузка списка датчиков через `GET /api/sensors` (+ fallback на `/api/sm/sensors`)
- [x] Фильтрация по name, textname, iotype
- [x] Обработка ESC: 1-й раз — сброс фильтра + убрать фокус, 2-й раз — закрытие окна
- [x] Сохранение выбранных датчиков в localStorage (`uniset2-viewer-external-sensors-{objectName}`)
- [x] Восстановление датчиков при открытии вкладки
- [x] Endpoint `/api/sm/sensors` для загрузки датчиков из SharedMemory
- [x] Config: `--sm-url`, `--sm-poll-interval`
- [x] SM клиент (`internal/sm/client.go`)
- [x] API endpoints для подписки/отписки на датчики
- [x] SM Poller с SSE событиями `sensor_data`
- [x] Сохранение истории в storage
- [x] Обработка SSE события `sensor_data`
- [x] Создание графиков для внешних датчиков
- [x] Восстановление подписок при загрузке страницы
- [x] Кнопка удаления внешнего датчика с графика
- [x] Playwright и Go тесты

### LogServer клиент

- [x] `internal/logserver/types.go` - структура Message, команды, константы
- [x] `internal/logserver/client.go` - TCP клиент с auto-reconnect
- [x] `internal/logserver/manager.go` - менеджер клиентов
- [x] API endpoints: stream, command, status
- [x] UI: LogViewer компонент (terminal-like, 2000 строк буфер)
- [x] UI: Опция "По умолчанию" в уровне логов
- [x] UI: Сообщение "Ожидание сообщений..." при подключении без логов
- [x] Backend: Корректное закрытие TCP соединения

### LogViewer улучшения
- [x] Dropdown выбора уровней логов — pills для каждого уровня, пресеты
- [x] Локальная фильтрация с подсветкой (Regex, Case, Только совпадения)
- [x] Экспорт логов в файл (кнопка скачивания)
- [x] Настройка размера буфера (500-10000)
- [x] Счётчики: текущее/максимум, количество совпадений
- [x] Горячие клавиши: "/" для фокуса на фильтр, Esc для очистки

### SSE
- [x] Backend: endpoint `/api/events` с SSE stream
- [x] Backend: отправка событий при изменении данных объектов
- [x] UI: подписка на SSE вместо polling
- [x] UI: fallback на polling при отсутствии SSE
- [x] Go unit-тесты для SSE

### UI исправления
- [x] Переименовать "Переменные" в "Настройки"
- [x] LogServer: исправить проверку RUNNING
- [x] Таймеры: добавить столбец tick
- [x] Входы/Выходы: добавить столбец textname
- [x] Графики: добавить textname в шапку панели графика
- [x] textname: приоритет справочник, потом comment из API
- [x] LogServer: добавить все параметры (sessMaxCount, список сессий)
- [x] Переменные не вошедшие в io/Variables выводить в разделе Настройки
- [x] Входы/Выходы: столбец описание разместить в конце
- [x] Потеряно > 0 подсвечивать жёлтым (warning)

### Информация об объекте
- [x] Первой строкой выводить: "Потеряно сообщений: xxx | Макс. размер очереди: yyy"

### Таймеры
- [x] Оставшееся время (timeleft) обновляется локально (100мс)
- [x] tick=-1 отображается как "∞"
- [x] Прогресс-бар для timeleft

### Типы объектов
- [x] Fallback-рендерер: сырой JSON и сообщение "тип объекта не поддерживается"

### Тестирование
- [x] Playwright тесты на рендереры объектов
- [x] Playwright тесты для LogViewer UI

### Прочее
- [x] Убрать заголовок таблицы легенды графика и вынести в шапку
- [x] Выбор цвета при клике на квадратик в легенде графика
- [x] Фильтрация переменных по имени с поддержкой ESC
- [x] Спойлеры (collapsible) для секций
- [x] Шкала времени на фиксированный интервал
- [x] Сворачиваемая боковая панель до значков
- [x] Дискретные графики без заливки по умолчанию
- [x] Чекбокс "фон" для включения/отключения заливки графика
- [x] Сохранение настроек интерфейса в localStorage
