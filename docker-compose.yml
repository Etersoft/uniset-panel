version: '3.8'

services:
  # Mock uniset2 server for testing
  mock-uniset:
    image: node:20-slim
    working_dir: /app
    volumes:
      - ./tests/mock-server:/app
      - ./.node_modules/mock:/app/node_modules
    command: node server.js
    ports:
      - "9393:9393"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9393/api/v01/list"]
      interval: 2s
      timeout: 5s
      retries: 5

  # Our viewer server
  viewer:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - UNISET_URL=http://mock-uniset:9393
    ports:
      - "8000:8000"
    depends_on:
      mock-uniset:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/objects"]
      interval: 2s
      timeout: 5s
      retries: 5

  # Playwright tests
  e2e:
    build:
      context: ./tests
      dockerfile: Dockerfile
    environment:
      - BASE_URL=http://viewer:8000
    volumes:
      - ./tests:/app
      - ./.node_modules/e2e:/app/node_modules
      - ./tests/test-results:/app/test-results
      - ./tests/playwright-report:/app/playwright-report
    depends_on:
      viewer:
        condition: service_healthy
