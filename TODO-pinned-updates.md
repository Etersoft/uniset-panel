# ‚úÖ –†–ï–®–ï–ù–û: –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤ –≤ ModbusSlave

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–î–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–º—É –¥–∞—Ç—á–∏–∫—É –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ ModbusSlave –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ SSE —Å–æ–±—ã—Ç–∏–π.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (commit bcaed95)

**–ü—Ä–∏—á–∏–Ω–∞**: Modbus poller –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ JSON –≤ –æ—Ç–≤–µ—Ç–µ API.
- UniSet2 API endpoint `/get` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–µ `"sensors"`
- –ö–æ–¥ –æ–∂–∏–¥–∞–ª –ø–æ–ª–µ `"registers"`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: poller –ø–æ–ª—É—á–∞–ª 0 —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤, SSE —Å–æ–±—ã—Ç–∏—è –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `Sensors` –≤ struct `MBRegistersResponse`
2. –û–±–Ω–æ–≤–ª—ë–Ω poller –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–ª—è `Sensors` (—Å fallback –Ω–∞ `Registers`)
3. –î–æ–±–∞–≤–ª–µ–Ω–æ debug –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è polling –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: Poller —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ 198 —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SSE —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–π.

## –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç

```bash
cd /home/pv/Projects/uniset2-viewer-go

# –ó–∞–ø—É—Å—Ç–∏—Ç—å dev-viewer (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω)
docker-compose up dev-viewer -d

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç —Å –∏–º–∏—Ç–∞—Ü–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
node tests/debug/test-pinned-with-changes.js
```

### –†—É—á–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

1. –û—Ç–∫—Ä—ã—Ç—å http://localhost:8000
2. –û—Ç–∫—Ä—ã—Ç—å –æ–±—ä–µ–∫—Ç MBSlave1
3. –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
4. –ó–∞–∫—Ä–µ–ø–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä —Å ID=70 (–Ω–∞–∂–∞—Ç—å –Ω–∞ –∫—Ä—É–∂–æ–∫ —Å–ª–µ–≤–∞ –æ—Ç —Å—Ç—Ä–æ–∫–∏)
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 1 —Å—Ç—Ä–æ–∫–∞ (–∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–∞—è)
6. –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ:
   ```bash
   uniset2-mbtcptest -i localhost -p 2048 --write06 1 70 999
   ```
7. **–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ 999
8. **–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –∑–Ω–∞—á–µ–Ω–∏–µ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```bash
curl -s "http://localhost:9595/api/v2/MBSlave1/get?filter=70"
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ ModbusSlave
- ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ SSE –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–¥–ª—è –í–°–ï–• —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤, –Ω–µ —Ç–æ–ª—å–∫–æ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö)
- ‚úÖ –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤ (pin/unpin) - –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π
- ‚úÖ Backend API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç

- ‚ùå SSE —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤
- ‚ùå DOM –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ SSE –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

**Backend flow:**
1. `internal/modbus/poller.go` - –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä—ã –∫–∞–∂–¥—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (pollInterval)
2. `hasValueChanged()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ
3. –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `BatchUpdateCallback`
4. `internal/api/sse.go:BroadcastModbusRegisterBatchWithServer()` - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SSE —Å–æ–±—ã—Ç–∏–µ

**Frontend flow:**
1. `ModbusSlaveRenderer.subscribeToSSE()` (app.js:5224) - –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –í–°–ï —Ä–µ–≥–∏—Å—Ç—Ä—ã
2. SSE listener (app.js:395) - –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è `modbus_register_batch`
3. `handleModbusRegisterUpdates()` (app.js:5233) - –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
4. `batchRenderUpdates()` (app.js:5246) - –æ–±–Ω–æ–≤–ª—è–µ—Ç DOM

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

#### 1. Backend –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SSE —Å–æ–±—ã—Ç–∏—è

**–ì–∏–ø–æ—Ç–µ–∑–∞**: Poller –Ω–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä—ã –∏–ª–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ poller
docker logs uniset2-viewer-go-dev-viewer-1 2>&1 | grep -i modbus

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ API
curl "http://localhost:8000/api/objects/MBSlave1/modbus/subscriptions?server=77b5af18"

# –í–∫–ª—é—á–∏—Ç—å debug –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
# –î–æ–±–∞–≤–∏—Ç—å –≤ poller.go:
# slog.Debug("Modbus poll result", "object", objectName, "registers", len(registers))
```

**–ö–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏**: `internal/modbus/poller.go:187-236` (–º–µ—Ç–æ–¥ `poll()`)

#### 2. SSE —Å–æ–±—ã—Ç–∏—è –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è/–Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ –±—Ä–∞—É–∑–µ—Ä–∞

**–ì–∏–ø–æ—Ç–µ–∑–∞**: –°–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è backend, –Ω–æ –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ frontend

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
```javascript
// –í –±—Ä–∞—É–∑–µ—Ä–Ω–æ–π –∫–æ–Ω—Å–æ–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å SSE connection
window.state.sse

// –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö SSE —Å–æ–±—ã—Ç–∏–π
const eventSource = new EventSource('/api/events');
eventSource.onmessage = (e) => console.log('SSE event:', e);
```

#### 3. Frontend –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤

**–ì–∏–ø–æ—Ç–µ–∑–∞**: –°–æ–±—ã—Ç–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç, –Ω–æ `batchRenderUpdates()` –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç DOM –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ debug —Å–∫—Ä–∏–ø—Ç**: `tests/debug/test-pinned-with-changes.js`
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç MutationObserver –Ω–∞ —è—á–µ–π–∫—É –∑–Ω–∞—á–µ–Ω–∏—è
- –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç `handleModbusRegisterUpdates()`
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ SSE —Å–æ–±—ã—Ç–∏—è –∏ DOM –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–ö–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏**: `ui/static/js/app.js:5246-5300` (`batchRenderUpdates()`)

## Debug —Å–∫—Ä–∏–ø—Ç—ã

### 1. –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç SSE —Å–æ–±—ã—Ç–∏–π
```bash
node tests/debug/debug-modbusslave-sse.js
```

### 2. –¢–µ—Å—Ç –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤
```bash
node tests/debug/debug-pinned-updates.js
```

### 3. –¢–µ—Å—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –∑–Ω–∞—á–µ–Ω–∏–π
```bash
node tests/debug/test-pinned-with-changes.js
```

## –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã

### Backend
- `internal/modbus/poller.go` - Modbus poller, –æ–ø—Ä–æ—Å —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
- `internal/api/handlers.go:1187-1228` - SubscribeModbusRegisters endpoint
- `internal/api/sse.go:173-199` - BroadcastModbusRegisterBatchWithServer
- `internal/server/instance.go:101` - —Å–æ–∑–¥–∞–Ω–∏–µ Modbus poller

### Frontend
- `ui/static/js/app.js:4702-5324` - ModbusSlaveRenderer –∫–ª–∞—Å—Å
- `ui/static/js/app.js:5224-5227` - subscribeToSSE()
- `ui/static/js/app.js:5246-5300` - batchRenderUpdates()
- `ui/static/js/app.js:5105-5177` - renderRegisters()
- `ui/static/js/app.js:395-423` - SSE event listener
- `ui/static/js/app.js:1020-1083` - PinManagementMixin

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –°–æ–∑–¥–∞–Ω debug —Å–∫—Ä–∏–ø—Ç —Å –∏–º–∏—Ç–∞—Ü–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ, —á—Ç–æ SSE —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
3. üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ poller –Ω–∞ backend
4. üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ª–∏ SSE —Å–æ–±—ã—Ç–∏—è –æ—Ç backend
5. üîÑ –î–æ–±–∞–≤–∏—Ç—å debug –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ poller
6. üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–º–∏ –∏ –Ω–µ–∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–º–∏ –¥–∞—Ç—á–∏–∫–∞–º–∏

## –ó–∞–º–µ—Ç–∫–∏

- –í —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—á–Ω—ã ‚Üí poller –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SSE —Å–æ–±—ã—Ç–∏—è (–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
- –ö–æ–º–∞–Ω–¥–∞ `uniset2-mbtcptest` –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ (–≤–æ–∑–º–æ–∂–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–≤–æ–¥–∞)
- –†–µ–≥–∏—Å—Ç—Ä 70 —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ API), –Ω–æ SSE —Å–æ–±—ã—Ç–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç
- –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ SSE —É—Å–ø–µ—à–Ω–∞ (–≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ "ModbusSlave SSE: –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 200 —ç–ª–µ–º–µ–Ω—Ç–æ–≤")
